name: Daily S&P 500 Ranking v5.4

on:
  workflow_dispatch:
  schedule:
    - cron: "15 0 * * 1-5"  # Weekdays 00:15 UTC
  repository_dispatch:
    types: [breakout_signals_ready]

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  rank_and_deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Log trigger source
        run: |
          echo "â”€â”€ Trigger info â”€â”€"
          echo "Event: ${{ github.event_name }}"
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "Type: ${{ github.event.action }}"
            echo "Scan date: ${{ github.event.client_payload.scan_date }}"
            echo "ğŸ”” Triggered by MOZES_stock-screener breakout signals"
          elif [ "${{ github.event_name }}" = "schedule" ]; then
            echo "â° Scheduled daily run"
          else
            echo "ğŸ–±ï¸ Manual dispatch"
          fi

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # Cache v9: no v8 cache exists yet, so next run does full rebuild (incl. RS vs SPY). Then future runs use v8.
      - name: Restore S&P 500 cache (v9, 7 days)
        uses: actions/cache@v4
        with:
          path: sp500_cache_v9.pkl
          key: sp500-cache-v9-${{ runner.os }}-${{ github.run_id }}
          restore-keys: |
            sp500-cache-v9-${{ runner.os }}-

      - name: Fetch breakout_signals.json from screener
        run: |
          echo "â”€â”€ Fetching breakout_signals.json â”€â”€"

          # ×ª××™×“ ××‘×™× ×’×¨×¡×” ×˜×¨×™×™×” ××”×¡×§×¨×™× ×¨ (××§×•×¨ ×”×××ª ×”×™×—×™×“)
          curl -sf "https://raw.githubusercontent.com/Mozes2024/MOZES_stock-screener/main/breakout_signals.json" \
            -o breakout_signals.json

          if [ -f "breakout_signals.json" ]; then
            SIGNALS=$(python3 -c "import json; d=json.load(open('breakout_signals.json')); print(d.get('top_signals_count', 0))")
            SCAN=$(python3 -c "import json; d=json.load(open('breakout_signals.json')); print(d.get('scan_date',''))")
            echo "âœ… breakout_signals.json: ${SIGNALS} signals (scan: ${SCAN})"
          else
            echo "âš ï¸ breakout_signals.json not available â€” breakout tab will be empty"
          fi

      - name: Run ranking pipeline
        run: python sp500_github.py
        env:
          PYTHONUNBUFFERED: "1"

      - name: Commit sp500_data.json to repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git fetch origin main
          git pull --rebase --autostash origin main

          git add sp500_data.json || true
          git diff --staged --quiet || git commit -m "ğŸ“Š Update ranking data $(date +'%Y-%m-%d %H:%M')"
          git push || (sleep 3 && git push)

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
