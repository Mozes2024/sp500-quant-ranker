name: Daily S&P 500 Ranking v5.3

on:
  schedule:
    - cron: '0 13 * * 1-5'   # ×’×™×‘×•×™ - ×¨×¥ ×‘-13:00 UTC ×× ×”×¡×§×¨×™× ×¨ ×œ× ×”×¤×¢×™×œ
  repository_dispatch:
    types: [screener-update]  # â† ××•×¤×¢×œ ××•×˜×•××˜×™×ª ×¢"×™ MOZES_stock-screener
  workflow_dispatch:           # ×”×¤×¢×œ×” ×™×“× ×™×ª

# ××•× ×¢ ×”×ª× ×’×©×•×™×•×ª ×‘×™×Ÿ ×¨×™×¦×•×ª (schedule + dispatch + manual) ×©×›×•×œ×Ÿ ×× ×¡×•×ª ×œ×“×—×•×£ ×œ-main
concurrency:
  group: sp500-ranker-main
  cancel-in-progress: false

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  rank:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Log trigger source
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "ğŸ”— Triggered automatically by MOZES_stock-screener"
            echo "   Scan date: ${{ github.event.client_payload.scan_date }}"
            echo "   Signals:   ${{ github.event.client_payload.signals_count }}"
          elif [ "${{ github.event_name }}" = "schedule" ]; then
            echo "â° Triggered by schedule (screener may not have run yet)"
          else
            echo "ğŸ‘¤ Triggered manually"
          fi

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install yfinance pandas numpy "openpyxl==3.1.2"                       requests beautifulsoup4 matplotlib seaborn                       tqdm scipy

      - name: Restore S&P 500 cache (7 days)
        uses: actions/cache@v4
        with:
          path: sp500_cache_v5.pkl
          key: sp500-cache-v5-${{ runner.os }}-${{ github.run_id }}
          restore-keys: |
            sp500-cache-v5-${{ runner.os }}-

      - name: Verify breakout signals
        run: |
          if [ -f "breakout_signals.json" ]; then
            SIGNALS=$(python3 -c "import json; d=json.load(open('breakout_signals.json')); print(d.get('top_signals_count', 0))")
            SCAN=$(python3 -c "import json; d=json.load(open('breakout_signals.json')); print(d.get('scan_date',''))")
            echo "âœ… breakout_signals.json ready: $SIGNALS signals (scan: $SCAN)"
          else
            # ×”×¡×§×¨×™× ×¨ ×“×•×—×£ ××ª breakout_signals.json ×™×©×™×¨×•×ª ×œ×¨×™×¤×• ×”×–×” ×“×¨×š GitHub API.
            # ×× ××™×Ÿ ×§×•×‘×¥ (×œ××©×œ ×¨×™×¦×” ××ª×•×–×× ×ª ×œ×¤× ×™ ×”×¡×§×¨×™× ×¨) â€” × ××©×™×š ×‘×œ×™ merge.
            echo "âš  breakout_signals.json missing â€” continuing without breakout merge"
          fi

      - name: Run ranking pipeline
        run: python sp500_github.py
        env:
          PYTHONUNBUFFERED: "1"

      - name: Commit sp500_data.json to repo
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # ×ª××™×“ ×œ×”×¡×ª× ×›×¨×Ÿ ×¢× ×”-remote ×œ×¤× ×™ Push ×›×“×™ ×œ×× ×•×¢ 'fetch first'
          git fetch origin main
          git pull --rebase origin main

          git add sp500_data.json
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "ğŸ“Š Update ranking data $(date +'%Y-%m-%d %H:%M')"

          # × ×™×¡×™×•×Ÿ Push, ×•×× ×¢×“×™×™×Ÿ ×™×© ×”×ª× ×’×©×•×ª (× ×“×™×¨ ×›×©×™×© concurrency) â€” Pull+Rebase × ×•×¡×£ ×•-Push ×©×•×‘
          git push || (git pull --rebase origin main && git push)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sp500-ranking-${{ github.run_number }}
          path: artifacts/
          retention-days: 30

      - name: Deploy dashboard to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

  deploy-pages:
    needs: rank
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
