<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>S&P 500 Mozes Ranker</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#070c12; --surface:#0c1520; --surface2:#111d2b; --surface3:#162436;
  --border:#1d2e40; --border2:#243a50;
  --gold:#f5a623; --gold2:#ffc15e; --gold3:#fff3d6;
  --teal:#00d4aa; --teal2:#00f5c4; --red:#ff4757; --red2:#ff6b81;
  --blue:#4dabf7; --purple:#cc5de8; --green:#51cf66; --orange:#ff922b;
  --text:#dce8f4; --text2:#8aaccb; --text3:#4a6a8a; --text4:#2d4a65;
  --mono:'JetBrains Mono',monospace; --sans:'Inter',sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--text);font-family:var(--sans);min-height:100vh;font-size:15px;}
body.rtl{direction:rtl;}
header{padding:14px 28px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:linear-gradient(180deg,#0a1520 0%,var(--bg) 100%);position:sticky;top:0;z-index:300;}
.logo-title{font-size:20px;font-weight:900;color:#fff;letter-spacing:-.5px;}
.logo-title .logo-accent{color:var(--gold);}
.logo-sub{font-family:var(--mono);font-size:10px;color:var(--text3);letter-spacing:1.5px;margin-top:2px;}
.header-right{display:flex;align-items:center;gap:14px;}
.live-dot{width:7px;height:7px;border-radius:50%;background:var(--teal);box-shadow:0 0 8px var(--teal);display:inline-block;margin-right:6px;animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.4;transform:scale(1.5)}}
.last-updated{font-family:var(--mono);font-size:11px;color:var(--text2);}
.lang-wrap{display:flex;background:var(--surface);border:1px solid var(--border);border-radius:6px;overflow:hidden;}
.lang-btn{padding:5px 13px;font-family:var(--mono);font-size:11px;font-weight:700;cursor:pointer;transition:all .15s;border:none;background:transparent;color:var(--text3);letter-spacing:.5px;}
.lang-btn.active{background:var(--gold);color:#000;}
.stats-bar{display:grid;grid-template-columns:repeat(5,1fr);border-bottom:1px solid var(--border);}
.stat-item{padding:14px 24px;border-right:1px solid var(--border);}
.stat-item:last-child{border-right:none;}
.stat-label{font-size:11px;font-weight:600;color:var(--text3);letter-spacing:.8px;text-transform:uppercase;margin-bottom:5px;}
.stat-value{font-size:26px;font-weight:900;color:#fff;letter-spacing:-1px;}
.stat-accent{color:var(--gold);}
.controls{padding:12px 28px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;border-bottom:1px solid var(--border);background:var(--surface);position:sticky;top:61px;z-index:200;}
.search-wrap{position:relative;flex:0 0 230px;}
.search-icon{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--text3);font-size:14px;}
#search{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:8px 10px 8px 32px;font-family:var(--sans);font-size:13px;color:var(--text);outline:none;}
#search:focus{border-color:var(--gold);}
#search::placeholder{color:var(--text3);}
.filter-toggle{padding:7px 14px;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--text2);font-size:12px;font-weight:600;cursor:pointer;transition:all .15s;}
.filter-toggle:hover,.filter-toggle.open{border-color:var(--teal);color:var(--teal);}
.filter-panel{display:none;padding:14px 28px;gap:14px;flex-wrap:wrap;align-items:flex-end;border-bottom:1px solid var(--border);background:#090f18;}
.filter-panel.open{display:flex;}
.filter-group{display:flex;flex-direction:column;gap:5px;}
.filter-label{font-size:11px;font-weight:600;color:var(--text3);letter-spacing:.5px;text-transform:uppercase;}
.filter-range{display:flex;align-items:center;gap:6px;}
.filter-input{width:78px;background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:6px 8px;font-family:var(--mono);font-size:12px;color:var(--text);outline:none;}
.filter-input:focus{border-color:var(--teal);}
.filter-range span{color:var(--text3);}
.filter-select{background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:6px 8px;font-size:12px;color:var(--text);outline:none;cursor:pointer;}
.filter-reset{padding:6px 14px;border-radius:4px;border:1px solid var(--border);background:transparent;color:var(--text3);font-size:12px;font-weight:600;cursor:pointer;}
.filter-reset:hover{border-color:var(--red);color:var(--red);}
.sector-filters{display:flex;gap:5px;flex-wrap:wrap;flex:1;}
.sector-btn{padding:5px 11px;border-radius:5px;border:1px solid var(--border);background:transparent;color:var(--text2);font-size:12px;font-weight:600;cursor:pointer;transition:all .15s;white-space:nowrap;}
.sector-btn:hover{border-color:var(--gold);color:var(--gold);}
.sector-btn.active{background:var(--gold);border-color:var(--gold);color:#000;}
.count-badge{font-size:13px;font-weight:600;color:var(--text2);margin-left:auto;white-space:nowrap;}
.count-badge span{color:var(--gold);}
.view-tabs{padding:0 28px;display:flex;gap:2px;border-bottom:2px solid var(--border);background:var(--surface);position:sticky;top:107px;z-index:190;overflow-x:auto;}
.view-tabs::-webkit-scrollbar{height:3px;}
.view-tabs::-webkit-scrollbar-thumb{background:var(--border);}
.view-tab{padding:11px 18px;font-size:13px;font-weight:600;color:var(--text2);cursor:pointer;white-space:nowrap;border-bottom:3px solid transparent;margin-bottom:-2px;transition:all .2s;background:transparent;border-top:none;border-left:none;border-right:none;}
.view-tab:hover{color:var(--text);background:rgba(255,255,255,.03);}
.view-tab.active{color:var(--gold);border-bottom-color:var(--gold);background:rgba(245,166,35,.06);}
.table-wrap{overflow-x:auto;padding:0 28px 80px;}
table{width:100%;border-collapse:collapse;margin-top:12px;font-size:13px;table-layout:fixed;}
.col-rank{width:44px;}.col-ticker{width:76px;}.col-company{width:175px;}.col-sector{width:125px;}.col-data{width:105px;}
thead th{padding:10px 8px;text-align:center;font-size:11px;font-weight:700;letter-spacing:.4px;text-transform:uppercase;color:var(--text2);border-bottom:2px solid var(--border);white-space:nowrap;cursor:pointer;user-select:none;transition:color .15s;overflow:hidden;position:relative;}
thead th:hover{color:var(--gold2);}
thead th.sorted{color:var(--gold);}
thead th.sorted::after{content:' â†“';}
thead th.sorted.asc::after{content:' â†‘';}
.th-wrap{position:relative;display:inline-block;width:100%;}
.th-tip{visibility:hidden;opacity:0;position:fixed;background:#0d1e2e;border:1px solid var(--border2);color:var(--text);font-size:12px;font-family:var(--sans);font-weight:400;letter-spacing:0;text-transform:none;white-space:normal;padding:10px 14px;border-radius:7px;width:230px;line-height:1.6;z-index:9999;box-shadow:0 12px 40px #000d;pointer-events:none;transition:opacity .15s;}
thead th:hover .th-tip{visibility:visible;opacity:1;}
tbody tr{border-bottom:1px solid #0a1520;transition:background .1s;cursor:pointer;}
tbody tr:hover{background:var(--surface2);}
tbody tr.expanded{background:var(--surface2);}
td{padding:11px 8px;vertical-align:middle;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.td-rank{font-family:var(--mono);font-size:12px;font-weight:700;color:var(--text3);text-align:center;}
.td-rank.top3{color:var(--gold2);}
.td-ticker{font-family:var(--mono);font-size:14px;font-weight:800;color:#fff;}
.td-ticker a{color:inherit;text-decoration:none;border-bottom:1px solid transparent;transition:all .15s;}
.td-ticker a:hover{color:var(--gold);border-color:var(--gold);}
.td-company{color:var(--text2);font-size:12px;font-weight:500;}
.sector-pill{display:inline-block;padding:3px 8px;border-radius:4px;font-size:11px;font-weight:600;white-space:nowrap;}
.score-cell{display:flex;align-items:center;gap:7px;}
.score-num{font-family:var(--mono);font-size:13px;font-weight:700;width:38px;text-align:right;flex-shrink:0;}
.score-bar-bg{flex:1;height:5px;background:var(--border);border-radius:3px;overflow:hidden;}
.score-bar-fill{height:100%;border-radius:3px;transition:width .3s;}
.td-num{font-family:var(--mono);font-size:12px;text-align:center;font-weight:500;}
.td-num.pos{color:var(--teal);}
.td-num.neg{color:var(--red2);}
.td-num.neutral{color:var(--text2);}
.td-num.hi{color:#74e8c0;}
.td-num.mid{color:var(--gold2);}
.ss-badge{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:6px;font-family:var(--mono);font-size:12px;font-weight:800;}
.stock-detail-row{display:none;background:#060c14;border-bottom:2px solid var(--border);}
.stock-detail-row.open{display:table-row;}
.stock-detail-inner{padding:20px 52px 28px;}
.detail-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;}
.detail-ticker-big{font-family:var(--mono);font-size:22px;font-weight:800;color:#fff;}
.detail-company-name{font-size:14px;font-weight:500;color:var(--text2);}
.detail-price{font-family:var(--mono);font-size:22px;font-weight:800;color:var(--gold);}
.detail-pill-sector{padding:4px 10px;border-radius:4px;font-size:11px;font-weight:700;}
.detail-tabs{display:flex;gap:3px;border-bottom:1px solid var(--border);margin-bottom:16px;}
.detail-tab{padding:7px 15px;font-size:12px;font-weight:600;color:var(--text3);cursor:pointer;border-bottom:2px solid transparent;transition:all .15s;background:none;border-top:none;border-left:none;border-right:none;white-space:nowrap;}
.detail-tab:hover{color:var(--text);}
.detail-tab.active{color:var(--teal);border-bottom-color:var(--teal);}
.pillar-grid{display:grid;grid-template-columns:repeat(9,1fr);gap:10px;margin-bottom:20px;}
.pillar-card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:12px;text-align:center;}
.pillar-card-name{font-size:9px;font-weight:700;color:var(--text3);letter-spacing:.8px;text-transform:uppercase;margin-bottom:6px;}
.pillar-card-score{font-size:24px;font-weight:900;margin-bottom:6px;}
.pillar-bar-bg{height:4px;background:var(--border);border-radius:2px;overflow:hidden;}
.pillar-bar-fill{height:100%;border-radius:2px;}
.metrics-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;}
.metric-card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:11px 13px;}
.metric-label{font-size:10px;font-weight:700;color:var(--text3);letter-spacing:.5px;text-transform:uppercase;margin-bottom:4px;}
.metric-value{font-family:var(--mono);font-size:15px;font-weight:700;color:#fff;}
.metric-value.pos{color:var(--teal);}
.metric-value.neg{color:var(--red2);}
.metric-value.gold{color:var(--gold);}
.metric-sub{font-size:10px;color:var(--text3);margin-top:2px;}
.val-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;}
.val-card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:12px;text-align:center;}
.val-label{font-size:10px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.4px;margin-bottom:6px;}
.val-num{font-family:var(--mono);font-size:18px;font-weight:800;color:#fff;}
.tr-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;}
.tr-card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:14px;}
.tr-card-title{font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;}
.tr-card-main{font-family:var(--mono);font-size:20px;font-weight:800;color:#fff;margin-bottom:4px;}
.tr-card-sub{font-size:12px;color:var(--text2);}
.ss-big{display:inline-flex;align-items:center;justify-content:center;width:48px;height:48px;border-radius:10px;font-family:var(--mono);font-size:22px;font-weight:800;margin-bottom:6px;}
.sentiment-bar{height:8px;border-radius:4px;background:var(--border);overflow:hidden;margin:6px 0;}
.sentiment-fill{height:100%;border-radius:4px;}
#loading{display:flex;flex-direction:column;align-items:center;justify-content:center;height:60vh;gap:20px;}
.spinner{width:44px;height:44px;border:3px solid var(--border);border-top-color:var(--gold);border-radius:50%;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{font-size:13px;font-weight:600;color:var(--text2);letter-spacing:2px;animation:blink 1.5s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
#error-msg{display:none;text-align:center;padding:60px;color:var(--red);}
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:var(--bg);}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}
</style>
</head>
<body>
<header>
  <div class="logo-block">
    <div class="logo-title">S&amp;P 500 <span class="logo-accent">Mozes</span> Ranker</div>
    <div class="logo-sub">v5.3 Â· 9-Pillar + Breakout Scanner</div>
  </div>
  <div class="header-right">
    <div class="last-updated" id="lastUpdated"><span class="live-dot"></span>Loading...</div>
    <div class="lang-wrap">
      <button class="lang-btn active" id="btnEn" onclick="setLang('en')">EN</button>
      <button class="lang-btn" id="btnHe" onclick="setLang('he')">×¢×‘</button>
    </div>
  </div>
</header>
<div class="stats-bar" id="statsBar" style="display:none">
  <div class="stat-item"><div class="stat-label" id="lbl-ranked">Stocks Ranked</div><div class="stat-value" id="statTotal">â€”</div></div>
  <div class="stat-item"><div class="stat-label" id="lbl-avg">Avg Composite</div><div class="stat-value stat-accent" id="statAvg">â€”</div></div>
  <div class="stat-item"><div class="stat-label" id="lbl-topsec">Top Sector</div><div class="stat-value" id="statTopSector" style="font-size:16px;margin-top:4px">â€”</div></div>
  <div class="stat-item"><div class="stat-label" id="lbl-ss8">SmartScore â‰¥ 8</div><div class="stat-value stat-accent" id="statSS8">â€”</div></div>
  <div class="stat-item"><div class="stat-label" id="lbl-tr">TR Coverage</div><div class="stat-value" id="statTR">â€”</div></div>
</div>
<div class="controls" id="controls" style="display:none">
  <div class="search-wrap"><span class="search-icon">âŒ•</span><input type="text" id="search" placeholder="Search ticker or companyâ€¦"></div>
  <button class="filter-toggle" id="filterToggle" onclick="toggleFilter()">âš™ <span id="lbl-filters">FILTERS</span></button>
  <div class="sector-filters" id="sectorFilters"></div>
  <div class="count-badge"><span id="showCount">â€”</span> <span id="lbl-stocks">stocks</span></div>
</div>
<div class="filter-panel" id="filterPanel">
  <div class="filter-group"><div class="filter-label" id="lbl-f-composite">Composite Score</div><div class="filter-range"><input type="number" id="fCompMin" placeholder="Min" class="filter-input" min="0" max="100"><span>â€“</span><input type="number" id="fCompMax" placeholder="Max" class="filter-input" min="0" max="100"></div></div>
  <div class="filter-group"><div class="filter-label" id="lbl-f-ss">SmartScore Min</div><select id="fSSMin" class="filter-select"><option value="">Any</option><option value="8">â‰¥ 8</option><option value="9">â‰¥ 9</option><option value="10">= 10</option></select></div>
  <div class="filter-group"><div class="filter-label" id="lbl-f-consensus">Consensus</div><select id="fConsensus" class="filter-select"><option value="">Any</option><option value="StrongBuy">Strong Buy</option><option value="Buy">Buy</option><option value="Hold">Hold</option></select></div>
  <div class="filter-group"><div class="filter-label" id="lbl-f-pe">P/E Max</div><input type="number" id="fPEMax" placeholder="e.g. 25" class="filter-input"></div>
  <div class="filter-group"><div class="filter-label" id="lbl-f-perf">12M Return Min %</div><input type="number" id="fPerfMin" placeholder="e.g. 10" class="filter-input"></div>
  <div class="filter-group"><div class="filter-label" id="lbl-f-valuation">Val. Score Min</div><input type="number" id="fValMin" placeholder="e.g. 60" class="filter-input"></div>
  <button class="filter-reset" onclick="resetFilters()" id="lbl-f-reset">âœ• Reset</button>
</div>
<div class="view-tabs" id="viewTabs" style="display:none"></div>
<div id="loading"><div class="spinner"></div><div class="loading-text" id="loadingText">LOADING MARKET DATA...</div></div>
<div id="error-msg" style="font-size:14px;">âš  Could not load sp500_data.json<br><span style="color:var(--text2);font-size:12px;display:block;margin-top:8px">Run the GitHub Actions workflow first.</span></div>
<div class="table-wrap" id="tableWrap" style="display:none">
  <table id="mainTable"><thead id="tableHead"></thead><tbody id="tableBody"></tbody></table>
</div>
<script>

  function makeUrl(path){
    const u = new URL(path, window.location.href);
    // Always bust cache
    u.searchParams.set('v', Date.now().toString());
    return u.toString();
  }


const T={en:{ranked:'Stocks Ranked',avg:'Avg Composite',topsec:'Top Sector',ss8:'SmartScore â‰¥ 8',tr:'TR Coverage',stocks:'stocks',searchph:'Search ticker or companyâ€¦',filters:'FILTERS',reset:'âœ• Reset',fcomposite:'Composite Score',fss:'SmartScore Min',fconsensus:'Consensus',fpe:'P/E Max',fperf:'12M Return Min %',fval:'Val. Score Min',loading:'LOADING MARKET DATA...',allsectors:'ALL SECTORS',topSectors:{'Information Technology':'Info Tech','Communication Services':'Comm Svcs','Consumer Discretionary':'Cons Disc','Consumer Staples':'Cons Staples','Health Care':'Health'},tabs:{score:'ðŸ“Š Score',valuation:'ðŸ’° Valuation',profitability:'ðŸ’¹ Profitability',growth:'ðŸš€ Growth',cashflow:'ðŸ’µ Cash Flow',health:'ðŸ¦ Balance Sheet',momentum:'âš¡ Momentum',analyst:'ðŸ”­ Analyst',tipranks:'ðŸŽ¯ TipRanks',breakout:'âš¡ Breakout'},dtabs:{overview:'Overview',pillars:'Pillars',valuation:'Valuation',tipranks:'TipRanks'},cols:{rank:'#',ticker:'Ticker',company:'Company',sector:'Sector',composite:'Composite',valuation:'Valuation',smartscore:'SmartScore',consensus:'Consensus',pe:'P/E',fwd_pe:'Fwd P/E',peg:'PEG',ps:'P/S',pb:'P/B',ev_ebitda:'EV/EBITDA',fcf_yield:'FCF Yield %',pt_upside:'PT Upside %',div_yield:'Div Yield %',pillar_prof:'Pillar',roe:'ROE %',roa:'ROA %',roic:'ROIC %',net_margin:'Net Margin %',gross_margin:'Gross Margin %',op_margin:'Op. Margin %',eq_score:'EQ Score',piotroski_f:'Piotroski F',pillar_growth:'Pillar',rev_growth:'Rev Growth %',eps_growth:'EPS Growth %',fcf_margin:'FCF Margin %',tr_asset_gr:'Asset Growth %',pillar_fcf:'FCF Pillar',fcf_to_ni:'FCF/NI',payout_ratio:'Payout %',pillar_health:'Health Pillar',current_ratio:'Current Ratio',debt_equity:'Debt/Equity',altman_z:'Altman Z',beta:'Beta',pillar_mom:'Mom. Pillar',perf_12m:'12M %',perf_6m:'6M %',perf_3m:'3M %',perf_1m:'1M %',momentum:'Composite Mom.',tr_mom_12m:'TR Tech Mom.',pillar_analyst:'Analyst Pillar',analyst_mean:'Yahoo Rating',analysts:'# Analysts',tr_consensus:'TR Consensus',tr_pt_upside:'TR PT Upside %',tr_smartscore:'SmartScore',tr_news_bull:'News Bull. %',tr_blogger_bull:'Blogger Bull. %',tr_insider:'Insider',tr_hedge:'Hedge Fund',tr_inv_chg_30d:'Inv. 30D %',tr_inv_chg_7d:'Inv. 7D %',breakout_score:'Breakout Score',breakout_rank:'Scan Rank',breakout_phase:'Phase',breakout_rr:'Risk/Reward',breakout_rs:'Rel. Strength',breakout_stop:'Stop Loss',has_vcp:'VCP Pattern',vcp_quality:'VCP Quality',breakout_entry:'Entry Quality',vs_sector:'vs Sector',coverage:'Coverage %',p_profitability:'Profitab.',p_growth:'Growth',p_eq:'EQ Qual.',p_fcf:'FCF',p_health:'Health',p_momentum:'Momentum',p_analyst:'Analyst',p_piotroski:'Piotroski'},tips:{composite:'Weighted average of all 9 pillars (10â€“100). Higher = better overall quality + value.',valuation:'How cheap vs expensive vs sector peers. 100 = deeply undervalued.',smartscore:'TipRanks SmartScore 1â€“10: AI aggregation of analyst, news, insider and hedge fund signals.',pe:'Price / Earnings (trailing 12M). Lower = potentially cheaper.',fwd_pe:'Forward P/E on next 12M EPS estimate. More forward-looking.',roe:'Return on Equity: net income / equity. Measures how efficiently equity is used.',net_margin:'Net income / revenue. % of each dollar of revenue that ends as profit.',rev_growth:'Year-over-year revenue growth. Core measure of top-line momentum.',perf_12m:'12-month price return. Strongest predictor in momentum factor investing.',altman_z:'Altman Z-Score: > 3 = safe, 1.8â€“3 = grey zone, < 1.8 = distress.',beta:'Price volatility vs S&P 500. > 1 = amplified moves. < 1 = more stable.',vs_sector:'Composite score minus the sector median â€” how much above/below sector peers.',coverage:'Data completeness: % of the 17 core metrics available.'},detailLabels:{Price:'Price',MktCap:'Mkt Cap',AltmanZ:'Altman Z',PiotroskiF:'Piotroski F',DivYield:'Div Yield',vsSector:'vs Sector',Beta:'Beta',Analysts:'# Analysts',SmartScore:'SmartScore',Consensus:'TR Consensus',TRUpside:'TR PT Upside',Coverage:'Coverage'},sectors:{'Information Technology':'IT','Health Care':'Health','Financials':'Financials','Consumer Discretionary':'Cons D','Communication Services':'Comm','Industrials':'Industrials','Consumer Staples':'Cons S','Energy':'Energy','Real Estate':'Real Est.','Materials':'Materials','Utilities':'Utilities'},pillarNames:{VALUATION:'VALUATION',PROFITAB:'PROFITAB.',GROWTH:'GROWTH',EQ_QUAL:'EQ QUAL',FCF:'FCF',HEALTH:'HEALTH',MOMENTUM:'MOMENTUM',ANALYST:'ANALYST',PIOTROSKI:'PIOTROSKI'}},he:{ranked:'×ž× ×™×•×ª ×ž×“×•×¨×’×•×ª',avg:'×¦×™×•×Ÿ ×ž×ž×•×¦×¢',topsec:'×¡×§×˜×•×¨ ×ž×•×‘×™×œ',ss8:'×¦×™×•×Ÿ ×—×›× â‰¥ 8',tr:'×›×™×¡×•×™ TipRanks',stocks:'×ž× ×™×•×ª',searchph:'×—×¤×© ×˜×™×§×¨ ××• ×—×‘×¨×”â€¦',filters:'×¤×™×œ×˜×¨×™×',reset:'âœ• ××™×¤×•×¡',fcomposite:'×¦×™×•×Ÿ ×§×•×ž×¤×•×–×™×˜',fss:'×¦×™×•×Ÿ ×—×›× ×ž×™× .',fconsensus:'×§×•× ×¦× ×–×•×¡',fpe:'P/E ×ž×§×¡×™×ž×•×',fperf:'×ª×©×•××” 12M ×ž×™× . %',fval:'×¦×™×•×Ÿ ×©×•×•×™ ×ž×™× .',loading:'×˜×•×¢×Ÿ × ×ª×•× ×™ ×©×•×§...',allsectors:'×›×œ ×”×¡×§×˜×•×¨×™×',topSectors:{'Information Technology':'×˜×›× ×•×œ×•×’×™×”','Communication Services':'×ª×§×©×•×¨×ª','Consumer Discretionary':'×¦×¨×™×›×” ×ž×—×–×•×¨×™×ª','Consumer Staples':'×¦×¨×™×›×” ×‘×¡×™×¡×™×ª','Health Care':'×‘×¨×™××•×ª'},tabs:{score:'ðŸ“Š ×¦×™×•×Ÿ',valuation:'ðŸ’° ×©×•×•×™',profitability:'ðŸ’¹ ×¨×•×•×—×™×•×ª',growth:'ðŸš€ ×¦×ž×™×—×”',cashflow:'ðŸ’µ ×ª×–×¨×™×',health:'ðŸ¦ ×ž××–×Ÿ',momentum:'âš¡ ×ž×•×ž× ×˜×•×',analyst:'ðŸ”­ ×× ×œ×™×¡×˜×™×',tipranks:'ðŸŽ¯ TipRanks',breakout:'âš¡ ×¤×¨×™×¦×”'},dtabs:{overview:'×¡×§×™×¨×”',pillars:'×¤×™×œ×¨×™×',valuation:'×©×•×•×™',tipranks:'TipRanks'},cols:{rank:'#',ticker:'×˜×™×§×¨',company:'×—×‘×¨×”',sector:'×¡×§×˜×•×¨',composite:'×¦×™×•×Ÿ ×§×•×ž×¤×•×–×™×˜',valuation:'×©×•×•×™',smartscore:'×¦×™×•×Ÿ ×—×›×',consensus:'×§×•× ×¦× ×–×•×¡',pe:'P/E',fwd_pe:'P/E ×¢×ª×™×“×™',peg:'PEG',ps:'P/S',pb:'P/B',ev_ebitda:'EV/EBITDA',fcf_yield:'×ª×©×•××ª FCF %',pt_upside:'×™×¢×“ ×ž×—×™×¨ %',div_yield:'×ª×©×•××ª ×“×™×‘. %',pillar_prof:'×¤×™×œ×¨',roe:'ROE %',roa:'ROA %',roic:'ROIC %',net_margin:'×ž×¨×’×³×™×Ÿ × ×˜×• %',gross_margin:'×ž×¨×’×³×™×Ÿ ×’×•×œ×ž×™ %',op_margin:'×ž×¨×’×³×™×Ÿ ×ª×¤×¢×•×œ×™ %',eq_score:'××™×›×•×ª ×¨×•×•×—',piotroski_f:'Piotroski F',pillar_growth:'×¤×™×œ×¨',rev_growth:'×¦×ž×™×—×ª ×”×›× ×¡×•×ª %',eps_growth:'×¦×ž×™×—×ª EPS %',fcf_margin:'×ž×¨×’×³×™×Ÿ FCF %',tr_asset_gr:'×¦×ž×™×—×ª × ×›×¡×™× %',pillar_fcf:'×¤×™×œ×¨ FCF',fcf_to_ni:'FCF/×¨×•×•×—',payout_ratio:'×™×—×¡ ×—×œ×•×§×” %',pillar_health:'×¤×™×œ×¨ ×‘×¨×™××•×ª',current_ratio:'×™×—×¡ ×©×•×˜×£',debt_equity:'×—×•×‘/×”×•×Ÿ',altman_z:'Altman Z',beta:'×‘×˜×',pillar_mom:'×¤×™×œ×¨ ×ž×•×ž× ×˜×•×',perf_12m:'12M %',perf_6m:'6M %',perf_3m:'3M %',perf_1m:'1M %',momentum:'×ž×•×ž× ×˜×•× ×ž×©×•×§×œ×œ',tr_mom_12m:'×ž×•×ž× ×˜×•× TR',pillar_analyst:'×¤×™×œ×¨ ×× ×œ×™×¡×˜×™×',analyst_mean:'×“×™×¨×•×’ Yahoo',analysts:'×ž×¡×³ ×× ×œ×™×¡×˜×™×',tr_consensus:'×§×•× ×¦× ×–×•×¡ TR',tr_pt_upside:'×™×¢×“ TR %',tr_smartscore:'×¦×™×•×Ÿ ×—×›×',tr_news_bull:'×—×“×©×•×ª ×—×™×•×‘×™×•×ª %',tr_blogger_bull:'×‘×œ×•×’×¨×™× ×—×™×•×‘×™×™× %',tr_insider:'×ž×¡×—×¨ ×¤× ×™×',tr_hedge:'×§×¨× ×•×ª ×’×™×“×•×¨',tr_inv_chg_30d:'×ž×•×¡×“×™ 30×™ %',tr_inv_chg_7d:'×ž×•×¡×“×™ 7×™ %',breakout_score:'×¦×™×•×Ÿ ×¤×¨×™×¦×”',breakout_rank:'×“×™×¨×•×’ ×¡×§×× ×¨',breakout_phase:'×¤××–×”',breakout_rr:'×¡×™×›×•×™/×¡×™×›×•×Ÿ',breakout_rs:'×—×•×–×§ ×™×—×¡×™',breakout_stop:'×¡×˜×•×¤ ×œ×•×¡',has_vcp:'×“×¤×•×¡ VCP',vcp_quality:'××™×›×•×ª VCP',breakout_entry:'××™×›×•×ª ×›× ×™×¡×”',vs_sector:'×ž×•×œ ×¡×§×˜×•×¨',coverage:'×›×™×¡×•×™ × ×ª×•× ×™× %',p_profitability:'×¨×•×•×—×™×•×ª',p_growth:'×¦×ž×™×—×”',p_eq:'××™×›×•×ª ×¨×•×•×—',p_fcf:'FCF',p_health:'×‘×¨×™××•×ª',p_momentum:'×ž×•×ž× ×˜×•×',p_analyst:'×× ×œ×™×¡×˜×™×',p_piotroski:'Piotroski'},tips:{composite:'×ž×ž×•×¦×¢ ×ž×©×•×§×œ×œ ×©×œ 9 ×¤×™×œ×¨×™× (10â€“100).',valuation:'×¢×“ ×›×ž×” ×”×ž× ×™×” ×–×•×œ×” ×‘×™×—×¡ ×œ×¢×ž×™×ª×™× ×‘×¡×§×˜×•×¨.',smartscore:'×¦×™×•×Ÿ ×—×›× ×©×œ TipRanks 1â€“10.',pe:'×ž×—×™×¨ / ×¨×•×•×—. × ×ž×•×š = ×¤×•×˜× ×¦×™××œ ×–×•×œ ×™×•×ª×¨.',fwd_pe:'P/E ×¢×ª×™×“×™ ×¢×œ ×‘×¡×™×¡ ×ª×—×–×™×ª EPS.',roe:'×ª×©×•××” ×¢×œ ×”×”×•×Ÿ.',net_margin:'×¨×•×•×— × ×§×™ / ×”×›× ×¡×•×ª.',rev_growth:'×¦×ž×™×—×ª ×”×›× ×¡×•×ª ×©× ×” ×¢×œ ×©× ×”.',perf_12m:'×ª×©×•××ª ×ž×—×™×¨ ×œ-12 ×—×•×“×©×™×.',altman_z:'Altman Z-Score: > 3 = ×‘×˜×•×—.',beta:'×ª× ×•×“×ª×™×•×ª ×‘×™×—×¡ ×œ-S&P 500.',vs_sector:'×¦×™×•×Ÿ ×§×•×ž×¤×•×–×™×˜ ×¤×—×•×ª ×—×¦×™×•×Ÿ ×”×¡×§×˜×•×¨.',coverage:'×©×œ×ž×•×ª × ×ª×•× ×™×.'},detailLabels:{Price:'×ž×—×™×¨',MktCap:'×©×•×•×™ ×©×•×§',AltmanZ:'Altman Z',PiotroskiF:'Piotroski F',DivYield:'×ª×©×•××ª ×“×™×‘.',vsSector:'×ž×•×œ ×¡×§×˜×•×¨',Beta:'×‘×˜×',Analysts:'×× ×œ×™×¡×˜×™×',SmartScore:'×¦×™×•×Ÿ ×—×›×',Consensus:'×§×•× ×¦× ×–×•×¡ TR',TRUpside:'×™×¢×“ TR',Coverage:'×›×™×¡×•×™'},sectors:{'Information Technology':'×˜×›× ×•×œ×•×’×™×”','Health Care':'×‘×¨×™××•×ª','Financials':'×¤×™× × ×¡×™×','Consumer Discretionary':'×¦×¨×™×›×” ×ž×—×–×•×¨×™×ª','Communication Services':'×ª×§×©×•×¨×ª','Industrials':'×ª×¢×©×™×™×”','Consumer Staples':'×¦×¨×™×›×” ×‘×¡×™×¡×™×ª','Energy':'×× ×¨×’×™×”','Real Estate':'× ×“×œ"×Ÿ','Materials':'×—×•×ž×¨×™×','Utilities':'×ª×©×ª×™×•×ª'},pillarNames:{VALUATION:'×©×•×•×™',PROFITAB:'×¨×•×•×—×™×•×ª',GROWTH:'×¦×ž×™×—×”',EQ_QUAL:'××™×›×•×ª ×¨×•×•×—',FCF:'FCF',HEALTH:'×‘×¨×™××•×ª',MOMENTUM:'×ž×•×ž× ×˜×•×',ANALYST:'×× ×œ×™×¡×˜×™×',PIOTROSKI:'Piotroski'}}};

let lang='en';
function setLang(l){lang=l;document.body.classList.toggle('rtl',l==='he');document.getElementById('btnEn').classList.toggle('active',l==='en');document.getElementById('btnHe').classList.toggle('active',l==='he');applyI18n();if(allData.length)renderTable();}
function tl(k){return(T[lang]||T.en)[k]||(T.en)[k]||k;}
function tc(k){return((T[lang]||T.en).cols||T.en.cols)[k]||(T.en.cols)[k]||k;}
function tt(k){return((T[lang]||T.en).tips||T.en.tips)[k]||(T.en.tips)[k]||'';}
function ttab(k){return((T[lang]||T.en).tabs||T.en.tabs)[k]||(T.en.tabs)[k]||k;}
function tdtab(k){return((T[lang]||T.en).dtabs||T.en.dtabs)[k]||(T.en.dtabs)[k]||k;}
function tpillar(k){return((T[lang]||T.en).pillarNames||T.en.pillarNames)[k]||(T.en.pillarNames)[k]||k;}
function applyI18n(){const ids={'lbl-ranked':'ranked','lbl-avg':'avg','lbl-topsec':'topsec','lbl-ss8':'ss8','lbl-tr':'tr','lbl-stocks':'stocks','lbl-f-composite':'fcomposite','lbl-f-ss':'fss','lbl-f-consensus':'fconsensus','lbl-f-pe':'fpe','lbl-f-perf':'fperf','lbl-f-valuation':'fval','lbl-f-reset':'reset','lbl-filters':'filters','loadingText':'loading'};Object.entries(ids).forEach(([id,key])=>{const el=document.getElementById(id);if(el)el.textContent=tl(key);});document.getElementById('search').placeholder=tl('searchph');buildSectorBtns();buildViewTabs();if(allData.length)updateTopSector();}

const SECTOR_COLORS={'Information Technology':{bg:'#0d2137',color:'#4fc3f7'},'Health Care':{bg:'#0d2118',color:'#69f0ae'},'Financials':{bg:'#1a1a0d',color:'#fff176'},'Consumer Discretionary':{bg:'#1a100d',color:'#ffab91'},'Communication Services':{bg:'#150d1a',color:'#ce93d8'},'Industrials':{bg:'#0d1a1a',color:'#80deea'},'Consumer Staples':{bg:'#1a160d',color:'#ffcc80'},'Energy':{bg:'#1a0d0d',color:'#ef9a9a'},'Real Estate':{bg:'#0d1a13',color:'#a5d6a7'},'Materials':{bg:'#0d1318',color:'#90caf9'},'Utilities':{bg:'#120d1a',color:'#b39ddb'}};

function buildViews(){return{
score:[{key:'composite',lk:'composite',tk:'composite',fmt:scoreBar},{key:'valuation',lk:'valuation',tk:'valuation',fmt:v=>n(v,1),cls:valCls},{key:'p_profitability',lk:'p_profitability',tk:'composite',fmt:v=>n(v,1),cls:scoreCls},{key:'p_growth',lk:'p_growth',tk:'composite',fmt:v=>n(v,1),cls:scoreCls},{key:'p_fcf',lk:'p_fcf',tk:'composite',fmt:v=>n(v,1),cls:scoreCls},{key:'p_health',lk:'p_health',tk:'composite',fmt:v=>n(v,1),cls:scoreCls},{key:'p_momentum',lk:'p_momentum',tk:'composite',fmt:v=>n(v,1),cls:scoreCls},{key:'p_analyst',lk:'p_analyst',tk:'composite',fmt:v=>n(v,1),cls:scoreCls},{key:'p_piotroski',lk:'p_piotroski',tk:'composite',fmt:v=>n(v,1),cls:scoreCls},{key:'p_eq',lk:'p_eq',tk:'composite',fmt:v=>n(v,1),cls:scoreCls},{key:'tr_smartscore',lk:'smartscore',tk:'smartscore',fmt:ssBadge},{key:'coverage',lk:'coverage',tk:'coverage',fmt:v=>n(v,0,'%'),cls:'neutral'},{key:'vs_sector',lk:'vs_sector',tk:'vs_sector',fmt:v=>n(v,1),cls:signCls}],
valuation:[{key:'valuation',lk:'valuation',tk:'valuation',fmt:v=>n(v,1),cls:valCls},{key:'pe',lk:'pe',tk:'pe',fmt:v=>n(v,1),cls:'neutral'},{key:'fwd_pe',lk:'fwd_pe',tk:'fwd_pe',fmt:v=>n(v,1),cls:'neutral'},{key:'peg',lk:'peg',tk:'peg',fmt:v=>n(v,2),cls:'neutral'},{key:'ps',lk:'ps',tk:'ps',fmt:v=>n(v,2),cls:'neutral'},{key:'pb',lk:'pb',tk:'pb',fmt:v=>n(v,2),cls:'neutral'},{key:'ev_ebitda',lk:'ev_ebitda',tk:'ev_ebitda',fmt:v=>n(v,1),cls:'neutral'},{key:'fcf_yield',lk:'fcf_yield',tk:'fcf_yield',fmt:v=>n(v,1,'%'),cls:signCls},{key:'pt_upside',lk:'pt_upside',tk:'pt_upside',fmt:v=>n(v,1,'%'),cls:signCls},{key:'div_yield',lk:'div_yield',tk:'div_yield',fmt:v=>n(v,2,'%'),cls:'neutral'}],
profitability:[{key:'p_profitability',lk:'pillar_prof',tk:'composite',fmt:v=>n(v,1),cls:scoreCls},{key:'roe',lk:'roe',tk:'roe',fmt:v=>n(v,1,'%'),cls:pctDistCls('roe')},{key:'roa',lk:'roa',tk:'roa',fmt:v=>n(v,1,'%'),cls:pctDistCls('roa')},{key:'roic',lk:'roic',tk:'roic',fmt:v=>n(v,1,'%'),cls:pctDistCls('roic')},{key:'net_margin',lk:'net_margin',tk:'net_margin',fmt:v=>n(v,1,'%'),cls:pctDistCls('net_margin')},{key:'gross_margin',lk:'gross_margin',tk:'gross_margin',fmt:v=>n(v,1,'%'),cls:pctDistCls('gross_margin')},{key:'op_margin',lk:'op_margin',tk:'op_margin',fmt:v=>n(v,1,'%'),cls:pctDistCls('op_margin')},{key:'eq_score',lk:'eq_score',tk:'eq_score',fmt:v=>n(v,1),cls:'neutral'},{key:'piotroski_f',lk:'piotroski_f',tk:'piotroski_f',fmt:v=>n(v,0),cls:'neutral'}],
growth:[{key:'p_growth',lk:'pillar_growth',tk:'composite',fmt:v=>n(v,1),cls:scoreCls},{key:'rev_growth',lk:'rev_growth',tk:'rev_growth',fmt:v=>n(v,1,'%'),cls:pctDistCls('rev_growth')},{key:'eps_growth',lk:'eps_growth',tk:'eps_growth',fmt:v=>n(v,1,'%'),cls:pctDistCls('eps_growth')},{key:'fcf_margin',lk:'fcf_margin',tk:'fcf_margin',fmt:v=>n(v,1,'%'),cls:pctDistCls('fcf_margin')},{key:'tr_asset_gr',lk:'tr_asset_gr',tk:'tr_asset_gr',fmt:v=>n(v,1,'%'),cls:pctDistCls('tr_asset_gr')}],
cashflow:[{key:'p_fcf',lk:'pillar_fcf',tk:'composite',fmt:v=>n(v,1),cls:scoreCls},{key:'fcf_yield',lk:'fcf_yield',tk:'fcf_yield',fmt:v=>n(v,1,'%'),cls:signCls},{key:'fcf_margin',lk:'fcf_margin',tk:'fcf_margin',fmt:v=>n(v,1,'%'),cls:signCls},{key:'fcf_to_ni',lk:'fcf_to_ni',tk:'fcf_to_ni',fmt:v=>n(v,2),cls:'neutral'},{key:'div_yield',lk:'div_yield',tk:'div_yield',fmt:v=>n(v,2,'%'),cls:'neutral'},{key:'payout_ratio',lk:'payout_ratio',tk:'payout_ratio',fmt:v=>n(v,1,'%'),cls:'neutral'}],
health:[{key:'p_health',lk:'pillar_health',tk:'composite',fmt:v=>n(v,1),cls:scoreCls},{key:'current_ratio',lk:'current_ratio',tk:'current_ratio',fmt:v=>n(v,2),cls:'neutral'},{key:'debt_equity',lk:'debt_equity',tk:'debt_equity',fmt:v=>n(v,2),cls:'neutral'},{key:'altman_z',lk:'altman_z',tk:'altman_z',fmt:v=>n(v,2),cls:altmanCls},{key:'piotroski_f',lk:'piotroski_f',tk:'piotroski_f',fmt:v=>n(v,0),cls:'neutral'},{key:'beta',lk:'beta',tk:'beta',fmt:v=>n(v,2),cls:'neutral'}],
momentum:[{key:'p_momentum',lk:'pillar_mom',tk:'composite',fmt:v=>n(v,1),cls:scoreCls},{key:'perf_12m',lk:'perf_12m',tk:'perf_12m',fmt:v=>n(v,1,'%'),cls:pctDistCls('perf_12m')},{key:'perf_6m',lk:'perf_6m',tk:'perf_6m',fmt:v=>n(v,1,'%'),cls:pctDistCls('perf_6m')},{key:'perf_3m',lk:'perf_3m',tk:'perf_3m',fmt:v=>n(v,1,'%'),cls:pctDistCls('perf_3m')},{key:'perf_1m',lk:'perf_1m',tk:'perf_1m',fmt:v=>n(v,1,'%'),cls:signCls},{key:'momentum',lk:'momentum',tk:'momentum',fmt:v=>n(v,1,'%'),cls:pctDistCls('momentum')},{key:'beta',lk:'beta',tk:'beta',fmt:v=>n(v,2),cls:'neutral'},{key:'tr_mom_12m',lk:'tr_mom_12m',tk:'tr_mom_12m',fmt:v=>n(v,1,'%'),cls:signCls}],
analyst:[{key:'p_analyst',lk:'pillar_analyst',tk:'composite',fmt:v=>n(v,1),cls:scoreCls},{key:'analyst_mean',lk:'analyst_mean',tk:'analyst_mean',fmt:v=>n(v,2),cls:'neutral'},{key:'analysts',lk:'analysts',tk:'analysts',fmt:v=>n(v,0),cls:'neutral'},{key:'pt_upside',lk:'pt_upside',tk:'pt_upside',fmt:v=>n(v,1,'%'),cls:signCls},{key:'tr_consensus',lk:'tr_consensus',tk:'consensus',fmt:consensusFmt},{key:'tr_pt_upside',lk:'tr_pt_upside',tk:'tr_pt_upside',fmt:v=>n(v,1,'%'),cls:signCls}],
breakout:[{key:'breakout_score',lk:'breakout_score',tk:'breakout_score',fmt:v=>breakoutScoreBadge(v)},{key:'breakout_rank',lk:'breakout_rank',tk:'breakout_rank',fmt:v=>n(v,0),cls:'neutral'},{key:'breakout_phase',lk:'breakout_phase',tk:'breakout_phase',fmt:v=>phaseBadge(v)},{key:'breakout_rr',lk:'breakout_rr',tk:'breakout_rr',fmt:v=>n(v,1,'x'),cls:'neutral'},{key:'breakout_rs',lk:'breakout_rs',tk:'breakout_rs',fmt:v=>n(v,3),cls:rsCls},{key:'breakout_stop',lk:'breakout_stop',tk:'breakout_stop',fmt:v=>valid(v)?'$'+parseFloat(v).toFixed(2):'â€”',cls:'neutral'},{key:'has_vcp',lk:'has_vcp',tk:'has_vcp',fmt:v=>v?'<span style="color:var(--gold);font-weight:700">âœ¦ VCP</span>':'â€”'},{key:'vcp_quality',lk:'vcp_quality',tk:'vcp_quality',fmt:v=>n(v,0),cls:'neutral'},{key:'breakout_entry',lk:'breakout_entry',tk:'breakout_entry',fmt:v=>v||'â€”'}],
tipranks:[{key:'tr_smartscore',lk:'tr_smartscore',tk:'smartscore',fmt:ssBadge},{key:'tr_consensus',lk:'tr_consensus',tk:'consensus',fmt:consensusFmt},{key:'tr_pt_upside',lk:'tr_pt_upside',tk:'tr_pt_upside',fmt:v=>n(v,1,'%'),cls:signCls},{key:'tr_news_bull',lk:'tr_news_bull',tk:'tr_news_bull',fmt:v=>n(v,0,'%'),cls:'neutral'},{key:'tr_blogger_bull',lk:'tr_blogger_bull',tk:'tr_blogger_bull',fmt:v=>n(v,0,'%'),cls:'neutral'},{key:'tr_insider',lk:'tr_insider',tk:'tr_insider',fmt:v=>v||'â€”'},{key:'tr_hedge',lk:'tr_hedge',tk:'tr_hedge',fmt:v=>v||'â€”'},{key:'tr_inv_chg_30d',lk:'tr_inv_chg_30d',tk:'tr_inv_chg_30d',fmt:v=>n(v,1,'%'),cls:signCls},{key:'tr_inv_chg_7d',lk:'tr_inv_chg_7d',tk:'tr_inv_chg_7d',fmt:v=>n(v,1,'%'),cls:signCls}],
};}

function breakoutScoreBadge(v){if(!valid(v))return'<span style="color:var(--text4)">â€”</span>';const f=parseFloat(v);const c=f>=100?'#ffd700':f>=90?'var(--teal)':f>=75?'var(--gold)':'var(--text2)';return`<span style="color:${c};font-family:var(--mono);font-weight:800;font-size:13px">${f.toFixed(1)}</span>`;}
function phaseBadge(v){if(!valid(v))return'<span style="color:var(--text4)">â€”</span>';const colors={1:'#ffd600',2:'var(--teal)',3:'var(--orange)',4:'var(--red)'};const labels={1:'Base',2:'Uptrend',3:'Top',4:'Down'};const c=colors[v]||'var(--text2)';return`<span style="color:${c};font-weight:700">P${v} <span style="font-size:10px;opacity:.7">${labels[v]||''}</span></span>`;}
function rsCls(v){if(!valid(v))return'neutral';return parseFloat(v)>=1?'pos':parseFloat(v)>=0.9?'mid':'neg';}
function n(v,dec=1,suf=''){if(v===null||v===undefined||isNaN(Number(v)))return'<span style="color:var(--text4)">â€”</span>';return parseFloat(v).toFixed(dec)+suf;}
function valid(v){return v!==null&&v!==undefined&&!isNaN(Number(v))&&v!=='';}
function signCls(v){if(!valid(v))return'neutral';return parseFloat(v)>0?'pos':parseFloat(v)<0?'neg':'neutral';}
function scoreCls(v){if(!valid(v))return'neutral';return parseFloat(v)>=65?'pos':parseFloat(v)>=40?'neutral':'neg';}
function valCls(v){if(!valid(v))return'neutral';return parseFloat(v)>=60?'pos':parseFloat(v)<=30?'neg':'neutral';}
function altmanCls(v){if(!valid(v))return'neutral';return parseFloat(v)>=3?'pos':parseFloat(v)>=1.8?'neutral':'neg';}

let _fieldP={};
function buildPercentiles(data){const keys=['roe','roa','roic','net_margin','gross_margin','op_margin','rev_growth','eps_growth','fcf_margin','tr_asset_gr','perf_12m','perf_6m','perf_3m','perf_1m','momentum'];keys.forEach(k=>{const vals=data.map(d=>d[k]).filter(v=>valid(v)).map(Number).sort((a,b)=>a-b);if(!vals.length){_fieldP[k]={p25:0,p50:0,p75:0};return;}const p=pct=>vals[Math.floor(pct*(vals.length-1))];_fieldP[k]={p25:p(.25),p50:p(.5),p75:p(.75)};});}
function pctDistCls(field){return v=>{if(!valid(v))return'neutral';const p=_fieldP[field];if(!p)return signCls(v);const f=parseFloat(v);if(f>=p.p75)return'pos';if(f>=p.p50)return'hi';if(f>=p.p25)return'mid';return'neg';};}

function scoreColor(v){if(!valid(v))return'var(--text4)';const f=parseFloat(v);if(f>=70)return'var(--teal)';if(f>=55)return'var(--gold)';if(f>=40)return'var(--orange)';return'var(--red)';}
function pillarColor(v){if(!valid(v))return'var(--text4)';const f=parseFloat(v);if(f>=65)return'var(--teal)';if(f>=45)return'var(--gold)';return'var(--red)';}
function ssColorFn(v){if(!v)return{bg:'#1e2e42',color:'var(--text3)'};if(v>=8)return{bg:'#0d3320',color:'#00e676'};if(v>=6)return{bg:'#1a2e0d',color:'#76ff03'};if(v>=4)return{bg:'#2e2400',color:'#ffd600'};return{bg:'#2e0d0d',color:'#ff5252'};}
function scoreBar(v){const c=scoreColor(v);const num=valid(v)?parseFloat(v).toFixed(1):'â€”';return`<div class="score-cell"><span class="score-num" style="color:${c}">${num}</span><div class="score-bar-bg"><div class="score-bar-fill" style="width:${valid(v)?parseFloat(v):0}%;background:${c}"></div></div></div>`;}
function ssBadge(v){const c=ssColorFn(v);return`<span class="ss-badge" style="background:${c.bg};color:${c.color}">${v||'â€”'}</span>`;}
function consensusFmt(v){if(!v)return'<span style="color:var(--text4)">â€”</span>';const c=v==='StrongBuy'?'#00e676':v.includes('Buy')?'#69f0ae':v==='Hold'?'#ffd600':'#ff5252';return`<span style="color:${c};font-size:12px;font-weight:600">${v.replace('Moderate','Mod ').replace('Strong','Str. ')}</span>`;}

let allData=[],currentSector='ALL',currentSearch='',currentView='score',sortCol='rank',sortAsc=true;

async function loadData(){
  try{
    const r=await fetch(makeUrl("sp500_data.json"));
    if(!r.ok)throw new Error(`HTTP ${r.status}`);
    const json=await r.json();
    allData=json.data;
    document.getElementById('lastUpdated').innerHTML=`<span class="live-dot"></span>${json.generated||''}`;
    buildPercentiles(allData);
    init();
  }catch(e){
    document.getElementById('loading').style.display='none';
    document.getElementById('error-msg').style.display='block';
  }
}

function updateTopSector(){const secMap={};allData.forEach(d=>{if(!secMap[d.sector])secMap[d.sector]=[];secMap[d.sector].push(d.composite||0);});const topSec=Object.entries(secMap).map(([s,v])=>[s,v.reduce((a,b)=>a+b,0)/v.length]).sort((a,b)=>b[1]-a[1])[0][0];const topMap=(T[lang]||T.en).topSectors||T.en.topSectors;document.getElementById('statTopSector').textContent=topMap[topSec]||topSec;}

function init(){
  document.getElementById('loading').style.display='none';
  document.getElementById('statsBar').style.display='grid';
  document.getElementById('controls').style.display='flex';
  document.getElementById('viewTabs').style.display='flex';
  document.getElementById('tableWrap').style.display='block';
  const nn=allData.length;
  const avg=(allData.reduce((a,b)=>a+(b.composite||0),0)/nn).toFixed(1);
  const ss8=allData.filter(d=>d.tr_smartscore>=8).length;
  const trCov=allData.filter(d=>d.tr_smartscore).length;
  document.getElementById('statTotal').textContent=nn;
  document.getElementById('statAvg').textContent=avg;
  document.getElementById('statSS8').textContent=ss8;
  document.getElementById('statTR').textContent=Math.round(trCov/nn*100)+'%';
  updateTopSector();buildSectorBtns();buildViewTabs();
  document.getElementById('search').addEventListener('input',e=>{currentSearch=e.target.value.toLowerCase();renderTable();});
  ['fCompMin','fCompMax','fSSMin','fConsensus','fPEMax','fPerfMin','fValMin'].forEach(id=>{const el=document.getElementById(id);if(el){el.addEventListener('change',renderTable);el.addEventListener('input',renderTable);}});
  renderTable();
}

function buildSectorBtns(){const c=document.getElementById('sectorFilters');c.innerHTML='';const sectors=['ALL',...Object.keys(SECTOR_COLORS).filter(s=>allData.some(d=>d.sector===s))];const sMap=(T[lang]||T.en).sectors||T.en.sectors;sectors.forEach(s=>{const btn=document.createElement('button');btn.className='sector-btn'+(s==='ALL'?' active':'');btn.textContent=s==='ALL'?tl('allsectors'):(lang==='he'?(sMap[s]||s):s.replace('Information Technology','IT').replace('Communication Services','COMM').replace('Consumer Discretionary','CONS D').replace('Consumer Staples','CONS S').replace('Health Care','HEALTH').toUpperCase());btn.addEventListener('click',()=>{document.querySelectorAll('.sector-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');currentSector=s;renderTable();});c.appendChild(btn);});}

function buildViewTabs(){const c=document.getElementById('viewTabs');c.innerHTML='';Object.keys(buildViews()).forEach(view=>{const btn=document.createElement('button');btn.className='view-tab'+(view===currentView?' active':'');btn.textContent=ttab(view);btn.dataset.view=view;btn.addEventListener('click',()=>{document.querySelectorAll('.view-tab').forEach(t=>t.classList.remove('active'));btn.classList.add('active');currentView=view;sortCol='rank';sortAsc=true;renderTable();});c.appendChild(btn);});}

function toggleFilter(){const panel=document.getElementById('filterPanel'),btn=document.getElementById('filterToggle');const open=panel.classList.toggle('open');btn.classList.toggle('open',open);}
function resetFilters(){['fCompMin','fCompMax','fSSMin','fConsensus','fPEMax','fPerfMin','fValMin'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});renderTable();}
function getFilters(){return{compMin:parseFloat(document.getElementById('fCompMin').value)||null,compMax:parseFloat(document.getElementById('fCompMax').value)||null,ssMin:parseFloat(document.getElementById('fSSMin').value)||null,consensus:document.getElementById('fConsensus').value||null,peMax:parseFloat(document.getElementById('fPEMax').value)||null,perfMin:parseFloat(document.getElementById('fPerfMin').value)||null,valMin:parseFloat(document.getElementById('fValMin').value)||null};}

function applyFilter(){let data=[...allData];const f=getFilters();if(currentSector!=='ALL')data=data.filter(d=>d.sector===currentSector);if(currentSearch)data=data.filter(d=>d.ticker.toLowerCase().includes(currentSearch)||(d.company||'').toLowerCase().includes(currentSearch));if(f.compMin!==null)data=data.filter(d=>(d.composite||0)>=f.compMin);if(f.compMax!==null)data=data.filter(d=>(d.composite||0)<=f.compMax);if(f.ssMin!==null)data=data.filter(d=>(d.tr_smartscore||0)>=f.ssMin);if(f.consensus)data=data.filter(d=>(d.tr_consensus||'')===f.consensus||(d.tr_consensus||'').includes(f.consensus.replace('Buy','').trim()));if(f.peMax!==null)data=data.filter(d=>valid(d.pe)&&parseFloat(d.pe)<=f.peMax);if(f.perfMin!==null)data=data.filter(d=>valid(d.perf_12m)&&parseFloat(d.perf_12m)>=f.perfMin);if(f.valMin!==null)data=data.filter(d=>(d.valuation||0)>=f.valMin);data.sort((a,b)=>{let av=a[sortCol],bv=b[sortCol];if(typeof av==='string')return sortAsc?(av||'').localeCompare(bv||''):(bv||'').localeCompare(av||'');if(!valid(av))return 1;if(!valid(bv))return-1;return sortAsc?parseFloat(av)-parseFloat(bv):parseFloat(bv)-parseFloat(av);});return data;}

function renderTable(){
  const filtered=applyFilter();
  document.getElementById('showCount').innerHTML=`<span>${filtered.length}</span>`;
  const VIEWS=buildViews(),cols=VIEWS[currentView];
  const thead=document.getElementById('tableHead');
  const mkth=(lk,col,w,tkOv)=>{const sorted=sortCol===col?(' sorted'+(sortAsc?' asc':'')):'';const tip=tt(tkOv||lk)||'';return`<th class="${sorted} col-${w}" data-col="${col}"><div class="th-wrap">${tc(lk)}<span class="th-tip">${tip}</span></div></th>`;};
  let hRow='<tr>'+mkth('rank','rank','rank')+mkth('ticker','ticker','ticker')+mkth('company','company','company')+mkth('sector','sector','sector');
  cols.forEach(c=>{const sorted=sortCol===c.key?(' sorted'+(sortAsc?' asc':'')):'';const tip=tt(c.tk)||'';hRow+=`<th class="${sorted} col-data" data-col="${c.key}"><div class="th-wrap">${tc(c.lk)}<span class="th-tip">${tip}</span></div></th>`;});
  hRow+='</tr>';thead.innerHTML=hRow;
  thead.querySelectorAll('th[data-col]').forEach(th=>{
    th.addEventListener('mouseenter',()=>{const tip=th.querySelector('.th-tip');if(!tip)return;const rect=th.getBoundingClientRect();tip.style.top=Math.max(8,rect.top-tip.offsetHeight-8)+'px';tip.style.left=Math.min(rect.left+rect.width/2-115,window.innerWidth-240)+'px';});
    th.addEventListener('click',()=>{const col=th.dataset.col;if(sortCol===col)sortAsc=!sortAsc;else{sortCol=col;sortAsc=['rank','ticker','company','sector'].includes(col);}renderTable();});
  });
  const tbody=document.getElementById('tableBody');tbody.innerHTML='';
  filtered.forEach(d=>{
    const sc=SECTOR_COLORS[d.sector]||{bg:'#1a1a1a',color:'#999'};
    const sMap=(T[lang]||T.en).sectors||T.en.sectors;
    const sLabel=lang==='he'?(sMap[d.sector]||d.sector):(d.sector||'').replace('Information Technology','IT').replace('Communication Services','Comm').replace('Consumer Discretionary','Cons D').replace('Consumer Staples','Cons S').replace('Health Care','Health');
    const isBreakout=valid(d.breakout_score);
    const doubleSignal=isBreakout&&(d.composite||0)>=65;
    let cells=`<td class="td-rank ${d.rank<=3?'top3':''}">${d.rank}</td><td class="td-ticker">${doubleSignal?'<span title="Double Signal!" style="color:var(--gold);font-size:10px;display:block;line-height:1">âš¡â˜…</span>':''}<a href="https://finance.yahoo.com/quote/${d.ticker}" target="_blank" onclick="event.stopPropagation()">${d.ticker}</a></td><td class="td-company" title="${d.company||''}">${(d.company||'').substring(0,24)}</td><td><span class="sector-pill" style="background:${sc.bg};color:${sc.color}">${sLabel}</span></td>`;
    cols.forEach(c=>{const raw=d[c.key];const content=c.fmt?c.fmt(raw):(valid(raw)?raw:'â€”');const cls=c.cls?(typeof c.cls==='function'?c.cls(raw):c.cls):'';cells+=`<td class="td-num ${cls}">${content}</td>`;});
    const tr=document.createElement('tr');tr.innerHTML=cells;
    const detailRow=document.createElement('tr');detailRow.className='stock-detail-row';
    detailRow.innerHTML=`<td colspan="99">${buildDetailPanel(d)}</td>`;
    tr.addEventListener('click',()=>{const isOpen=detailRow.classList.contains('open');document.querySelectorAll('.stock-detail-row.open').forEach(r=>r.classList.remove('open'));document.querySelectorAll('tr.expanded').forEach(r=>r.classList.remove('expanded'));if(!isOpen){detailRow.classList.add('open');tr.classList.add('expanded');}});
    tbody.appendChild(tr);tbody.appendChild(detailRow);
  });
}

function buildDetailPanel(d){
  const sc=SECTOR_COLORS[d.sector]||{bg:'#1a1a1a',color:'#999'};
  const sMap=(T[lang]||T.en).sectors||T.en.sectors;
  const sLabel=lang==='he'?(sMap[d.sector]||d.sector):d.sector;
  const ss=ssColorFn(d.tr_smartscore);
  const DL=(T[lang]||T.en).detailLabels||T.en.detailLabels;
  const pillarDefs=[['VALUATION',d.p_valuation],['PROFITAB',d.p_profitability],['GROWTH',d.p_growth],['EQ_QUAL',d.p_eq],['FCF',d.p_fcf],['HEALTH',d.p_health],['MOMENTUM',d.p_momentum],['ANALYST',d.p_analyst],['PIOTROSKI',d.p_piotroski]];
  const pillarGrid=pillarDefs.map(([k,v])=>`<div class="pillar-card"><div class="pillar-card-name">${tpillar(k)}</div><div class="pillar-card-score" style="color:${pillarColor(v)}">${valid(v)?parseFloat(v).toFixed(0):'â€”'}</div><div class="pillar-bar-bg"><div class="pillar-bar-fill" style="width:${valid(v)?parseFloat(v):0}%;background:${pillarColor(v)}"></div></div></div>`).join('');
  const mf=(label,val,cls='',sub='')=>`<div class="metric-card"><div class="metric-label">${label}</div><div class="metric-value ${cls}">${val}</div>${sub?`<div class="metric-sub">${sub}</div>`:''}</div>`;
  const metricsGrid=[mf(DL.Price,valid(d.price)?'$'+parseFloat(d.price).toFixed(2):'â€”','gold'),mf(DL.MktCap,valid(d.market_cap)?'$'+(d.market_cap/1e9).toFixed(1)+'B':'â€”'),mf(DL.DivYield,valid(d.div_yield)?parseFloat(d.div_yield).toFixed(2)+'%':'â€”'),mf(DL.Beta,valid(d.beta)?parseFloat(d.beta).toFixed(2):'â€”'),mf(DL.PiotroskiF,valid(d.piotroski_f)?d.piotroski_f:'â€”','','0â€“9'),mf(DL.AltmanZ,valid(d.altman_z)?parseFloat(d.altman_z).toFixed(2):'â€”',altmanCls(d.altman_z)),mf(DL.Analysts,d.analysts||'â€”'),mf(DL.vsSector,valid(d.vs_sector)?(parseFloat(d.vs_sector)>0?'+':'')+parseFloat(d.vs_sector).toFixed(1):'â€”',signCls(d.vs_sector)),mf(DL.Coverage,valid(d.coverage)?parseFloat(d.coverage).toFixed(0)+'%':'â€”'),mf('ROE %',valid(d.roe)?parseFloat(d.roe).toFixed(1)+'%':'â€”',signCls(d.roe)),mf('Net Margin',valid(d.net_margin)?parseFloat(d.net_margin).toFixed(1)+'%':'â€”',signCls(d.net_margin)),mf('Rev Growth',valid(d.rev_growth)?parseFloat(d.rev_growth).toFixed(1)+'%':'â€”',signCls(d.rev_growth))].join('');
  const valCards=[{l:'P/E',v:d.pe,dec:1},{l:'Fwd P/E',v:d.fwd_pe,dec:1},{l:'P/B',v:d.pb,dec:2},{l:'EV/EBITDA',v:d.ev_ebitda,dec:1},{l:'FCF Yield',v:d.fcf_yield,suf:'%',dec:1}].map(({l,v,dec,suf='',cls=''})=>`<div class="val-card"><div class="val-label">${l}</div><div class="val-num ${signCls(v)}">${valid(v)?parseFloat(v).toFixed(dec)+suf:'â€”'}</div></div>`).join('');
  const ptUpside=valid(d.pt_upside)?`<div class="val-card"><div class="val-label">PT Upside</div><div class="val-num ${signCls(d.pt_upside)}">${parseFloat(d.pt_upside).toFixed(1)}%</div></div>`:'';
  const trBull=valid(d.tr_news_bull)?parseFloat(d.tr_news_bull):null;
  const trBlogger=valid(d.tr_blogger_bull)?parseFloat(d.tr_blogger_bull):null;
  const trCard1=`<div class="tr-card"><div class="tr-card-title">SmartScore</div><div class="ss-big" style="background:${ss.bg};color:${ss.color}">${d.tr_smartscore||'â€”'}</div><div class="tr-card-sub">${(d.tr_consensus||'â€”').replace('Moderate','Mod ').replace('Strong','Str. ')}</div></div>`;
  const trCard2=`<div class="tr-card"><div class="tr-card-title">News Sentiment</div><div class="tr-card-main" style="color:${trBull&&trBull>50?'var(--teal)':'var(--red2)'}">${trBull!==null?trBull.toFixed(0)+'%':'â€”'}</div><div class="sentiment-bar"><div class="sentiment-fill" style="width:${trBull||0}%;background:${trBull&&trBull>50?'var(--teal)':'var(--red2)'}"></div></div><div class="tr-card-sub">Bullish news Â· ${trBlogger!==null?trBlogger.toFixed(0)+'%':'â€”'} bloggers</div></div>`;
  const trCard3=`<div class="tr-card"><div class="tr-card-title">Institutional & Insider</div><div class="tr-card-main">${d.tr_insider||'â€”'}</div><div class="tr-card-sub">Insider trading direction</div><div style="margin-top:8px"><div class="tr-card-title">30D Change</div><div class="metric-value ${signCls(d.tr_inv_chg_30d)}" style="font-size:16px">${valid(d.tr_inv_chg_30d)?parseFloat(d.tr_inv_chg_30d).toFixed(1)+'%':'â€”'}</div></div></div>`;
  return`<div class="stock-detail-inner"><div class="detail-header"><div><div style="display:flex;align-items:center;gap:10px;margin-bottom:4px"><span class="detail-ticker-big">${d.ticker}</span><span class="detail-pill-sector" style="background:${sc.bg};color:${sc.color}">${sLabel}</span></div><div class="detail-company-name">${d.company||''}</div></div><div style="text-align:right"><div class="detail-price">${valid(d.price)?'$'+parseFloat(d.price).toFixed(2):'â€”'}</div><div style="font-size:12px;color:var(--text2);margin-top:2px">Rank #${d.rank} Â· Score ${valid(d.composite)?parseFloat(d.composite).toFixed(1):'â€”'}</div><a href="https://finance.yahoo.com/quote/${d.ticker}" target="_blank" style="font-size:11px;color:var(--teal);text-decoration:none;display:inline-block;margin-top:4px">Open Yahoo Finance â†—</a></div></div><div class="detail-tabs" id="dtabs-${d.ticker}"><button class="detail-tab active" data-dtab="overview" onclick="switchDetailTab('${d.ticker}','overview')">Overview</button><button class="detail-tab" data-dtab="pillars" onclick="switchDetailTab('${d.ticker}','pillars')">Pillars</button><button class="detail-tab" data-dtab="valuation" onclick="switchDetailTab('${d.ticker}','valuation')">Valuation</button><button class="detail-tab" data-dtab="tipranks" onclick="switchDetailTab('${d.ticker}','tipranks')">TipRanks</button></div><div id="dtab-${d.ticker}-overview"><div class="metrics-grid">${metricsGrid}</div></div><div id="dtab-${d.ticker}-pillars" style="display:none"><div class="pillar-grid">${pillarGrid}</div></div><div id="dtab-${d.ticker}-valuation" style="display:none"><div class="val-grid">${valCards}${ptUpside}</div></div><div id="dtab-${d.ticker}-tipranks" style="display:none"><div class="tr-grid">${trCard1}${trCard2}${trCard3}</div></div></div>`;
}

function switchDetailTab(ticker,tab){const tc=document.getElementById(`dtabs-${ticker}`);if(!tc)return;tc.querySelectorAll('.detail-tab').forEach(t=>{t.classList.toggle('active',t.dataset.dtab===tab);});['overview','pillars','valuation','tipranks'].forEach(t=>{const el=document.getElementById(`dtab-${ticker}-${t}`);if(el)el.style.display=t===tab?'block':'none';});}

loadData();
</script>
</body>
</html>
